var express = require('express');
var path = require('path');
var bodyParser = require('body-parser');
var http = require('http');
var router = express.Router();
var result = loadModel('result');
var scenario = loadModel('scenario');

var view_dirname = 'result/views';
var data = [];
data.title = 'Result';
data.site_name = 'Result';
data.layout = '../base_views/layouts/home_layout';

router.use(bodyParser.json({limit: '50mb'}));
router.use(bodyParser.urlencoded({ limit: '50mb', extended: true }));
router.use(function(req, res, next) {
  res.header('Access-Control-Allow-Methods', 'GET, POST, DELETE');
  next();
});

// Display all or spesific result
router.get('/:id?', function(req, res, next) {
	if (req.params.id == undefined) {
		result.findAll().then(function(results) {
			res.json(results);
		});	
	} else {
		result.findOne({where: {id: req.params.id}}).then(function(currResult) {
			res.json(currResult);
		});
	}
});

router.get('/scenario/:scenarioId/:token?', function(req, res, next) {
	if (req.params.token == undefined) {
		result.findAll({where: {scenarios_id: req.params.scenarioId}, include: [scenario]}).then(function(results) {
			res.json(results);
		});	
	} else {
		result.findOne({where: {runningToken: req.params.token}, include: [scenario]}).then(function(currResult) {
			res.json(currResult);
		});
	}
});

// Store new result into database
router.post('/store', function(req, res, next) {
	result.create(req.body).then(function(insertData) {
		res.json({
			status: 'success', 
			id: insertData.id, 
			runningToken: insertData.runningToken,
			applicationName: req.body.applicationName,
			scannerUrl: req.body.scannerUrl,
			targetUrl: req.body.targetUrl});
	});
});

// Update certain result inside database
router.post('/update/:id', function(req, res, next) {
	result.update(req.body, { where: { id: req.params.id } }).then(function() {
		res.json({status: 'success'});
	});
});

// Delete certain result from database
router.delete('/destroy/:id', function(req, res, next) {
	result.destroy({ where: { id: req.params.id } }).then(function() {
		res.json({status: 'success'});
	});
});

module.exports = router;
