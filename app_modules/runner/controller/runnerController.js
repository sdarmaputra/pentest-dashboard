var express = require('express');
var path = require('path');
var bodyParser = require('body-parser');
var http = require('http');
var request = require('request');
var router = express.Router();
var scenario = loadModel('scenario');
var attack = loadModel('attack');
loadPenetrationModule('w3af');

var view_dirname = 'runner/views';
var data = [];
data.title = 'Attack List';
data.site_name = 'Pentest Dashboard';
data.layout = '../base_views/layouts/home_layout';
scenarioStatus = 'unavailable';

seriviceUrl = 'http://10.151.36.93:5000';

deployApplication = function(scenarioId, callback) {
	servicePath = '/deploy';

	scenario.findOne({ where: { id: scenarioId } }).then(function(currentScenario) {
	    var parameters = {
	    	'app_name': currentScenario.applicationName,
	    	'repo_name': currentScenario.repository
	    }
	    console.log(parameters);
	    request.post({url: seriviceUrl+'/deploy', formData: parameters}, function(err, res, body){
	    	console.log(body);
	    	callback(body);
	    });
	});
}

runScenario = function(scenarioId, callback) {
	stopCurrentTest(scenarioId, function(){
        deleteCurrentTest(scenarioId, function(){
          startNewTest(scenarioId, function(result){
            callback;
            //res.json({status: 'success'});
            //res.render(path.join(view_dirname, 'run'));
          });
        });
    });	
}

router.use(bodyParser.urlencoded({ extended: true }));
router.use(function(req, res, next) {
  res.header("Access-Control-Allow-Origin", "*");
  res.header('Access-Control-Allow-Methods', 'DELETE');
  next();
});

/* Run penetration test for certain scenario based on scenario ID */
router.get('/run/:id', function(req, res, next) {
	scenario.findOne({ where: { id: req.params.id } }).then(function(scenario) {
		if (scenario.runningStatus == 1) {
			runScenario(req.params.id, function() {
				res.json({status: 'success'});
			});
		} else {
			deployApplication(req.params.id, function(response){
				var result = JSON.parse(response);
				if (result.state == 'finished' && result.status == 'success') {
					runScenario(req.params.id, function() {
						res.json({status: 'success'});
					});
				}
			});
		}
			
	});
});

module.exports = router;
