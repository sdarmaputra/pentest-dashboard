var express = require('express');
var path = require('path');
var bodyParser = require('body-parser');
var router = express.Router();
var attack = loadModel('attack');

var view_dirname = 'attack/views';
var data = [];
data.title = 'Attack List';
data.site_name = 'Pentest Dashboard';
data.layout = '../base_views/layouts/home_layout';

router.use(bodyParser.urlencoded({ extended: true }));

router.use(function(req, res, next) {
  res.header("Access-Control-Allow-Origin", "*");
  res.header('Access-Control-Allow-Methods', 'DELETE');
  next();
});


// Display all attacks
router.get('/', function(req, res, next) {
	attack.findAll().then(function(attacks) {
		res.json(attacks);
	});
});

// Create new attack
router.get('/create', function(req, res, next) {
	data.attack = [];
	data.url = '/attack/store';
	res.render(path.join(view_dirname, 'create'), data);
});

// Store new attack into database
router.post('/store', function(req, res, next) {
	attack.create(req.body).then(function() {
		res.redirect('/attack');
	});
});

// Edit certain attack
router.get('/edit/:id', function(req, res, next) {
	attack.findOne({ where: { id: req.params.id } }).then(function(attack) {
		data.url = '/attack/update/'+req.params.id;
		data.attack = attack;
		res.render(path.join(view_dirname, 'edit'), data);
	});
});

// Update certain attack inside database
router.post('/update/:id', function(req, res, next) {
	attack.update(req.body, { where: { id: req.params.id } }).then(function() {
		//res.redirect('/attack/edit/'+req.params.id);
		res.json({status: 'success'});
	});
});

// Delete certain attack from database
router.delete('/destroy/:id', function(req, res, next) {
	attack.destroy({ where: { id: req.params.id } }).then(function() {
		//res.redirect('/attack');
		res.json({status: 'success'});
	});
});

module.exports = router;
